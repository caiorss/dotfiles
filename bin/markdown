#!/usr/bin/env ruby

if defined?(::Bundler) && ENV['GEM_PATH']
  gemsets = ENV['GEM_PATH'].split(':')
  gemsets.each do |gemset|
    $LOAD_PATH.concat Dir.glob("#{gemset}/gems/*/lib")
  end
end

require 'redcarpet'
require 'pygments'

class HTMLWithPygments < Redcarpet::Render::HTML
  def block_code(code, language)
    Pygments.highlight(code, :lexer => language)
  end
end

def render(text)
  markdown = Redcarpet::Markdown.new(
    HTMLWithPygments,
    :fenced_code_blocks => true,
    :filter_html => true,
    :hard_wrap => true,
  )

  puts '<style>'
  #puts Pygments.css('.highlight')
  puts CSS
  puts '</style>'
  puts '<div class="container">'
  puts '<div class="markdown-body">'
  puts markdown.render(text)
  puts '</div>'
  puts '</div>'
end

CSS = <<-EOF
.container{width:920px;margin: 0 auto}
.markdown-body{background-color:white;border:1px solid #CACACA;padding:30px}
.markdown-body code{white-space:nowrap}
pre,code,tt{font-size:12px;font-family:Consolas,"Liberation Mono",Courier,monospace}
body{font:13px Helvetica, arial, freesans, clean, sans-serif}
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,hgroup,menu,nav,output,ruby,section,summary,time,mark,audio,video{border:0;margin:0;padding:0}
.markdown-body h1 + p,.markdown-body h2 + p,.markdown-body h3 + p,.markdown-body h4 + p,.markdown-body h5 + p,.markdown-body h6 + p{margin-top:0}
.markdown-body ul li > :first-child,.markdown-body ul li ul:first-of-type,.markdown-body ol li > :first-child,.markdown-body ol li ul:first-of-type{margin-top:0px}
.markdown-body ul ul,.markdown-body ul ol,.markdown-body ol ol,.markdown-body ol ul{margin-bottom: 0}
.markdown-body p,.markdown-body blockquote,.markdown-body ul,.markdown-body ol,.markdown-body dl,.markdown-body table,.markdown-body pre{margin:15px 0}
.markdown-body{font-size:14px;line-height:1.6;overflow:hidden}
.markdown-body>:first-child{margin-top:0!important}
.markdown-body>:last-child{margin-bottom:0!important}
.markdown-body a.anchor{display:block;padding-left:30px;margin-left:-30px;cursor:pointer;position:absolute;top:0;left:0;bottom:0}
.markdown-body > h2:first-child,.markdown-body > h1:first-child,.markdown-body > h1:first-child + h2,.markdown-body > h3:first-child,.markdown-body > h4:first-child,.markdown-body > h5:first-child,.markdown-body > h6:first-child{margin-top:0;padding-top:0}
.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;-webkit-font-smoothing:antialiased;cursor:text;position:relative;margin:20px 0 10px;padding:0}
.markdown-body h1 .mini-icon-link,.markdown-body h2 .mini-icon-link,.markdown-body h3 .mini-icon-link,.markdown-body h4 .mini-icon-link,.markdown-body h5 .mini-icon-link,.markdown-body h6 .mini-icon-link{display:none;color:#000}
.markdown-body h1:hover a.anchor,.markdown-body h2:hover a.anchor,.markdown-body h3:hover a.anchor,.markdown-body h4:hover a.anchor,.markdown-body h5:hover a.anchor,.markdown-body h6:hover a.anchor{text-decoration:none;line-height:1;padding-left:0;margin-left:-22px;top:15%}
.markdown-body h1 tt,.markdown-body h1 code,.markdown-body h2 tt,.markdown-body h2 code,.markdown-body h3 tt,.markdown-body h3 code,.markdown-body h4 tt,.markdown-body h4 code,.markdown-body h5 tt,.markdown-body h5 code,.markdown-body h6 tt,.markdown-body h6 code{font-size:inherit}
.markdown-body h1{font-size:28px;color:#000}
.markdown-body h2{font-size:24px;border-bottom:1px solid #ccc;color:#000}
.markdown-body h6{color:#777;font-size:14px}
.markdown-body hr{background:transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;border:0 none;color:#ccc;height:4px;padding:0}
.markdown-body ul,.markdown-body ol{padding-left:30px}
.markdown-body ul.no-list,.markdown-body ol.no-list{list-style-type:none;padding:0}
.markdown-body dl dt{font-size:14px;font-weight:700;font-style:italic;margin:15px 0 5px;padding:0}
.markdown-body dl dd{margin:0 0 15px;padding:0 15px}
.markdown-body blockquote{border-left:4px solid #DDD;color:#777;padding:0 15px}
.markdown-body table th,.markdown-body table td{border:1px solid #ccc;padding:6px 13px}
.markdown-body table tr{border-top:1px solid #ccc;background-color:#fff}
.markdown-body table tr:nth-child(2n){background-color:#f8f8f8}
.markdown-body img{max-width:100%}
.markdown-body span.frame{display:block;overflow:hidden}
.markdown-body span.frame>span{border:1px solid #ddd;display:block;float:left;overflow:hidden;width:auto;margin:13px 0 0;padding:7px}
.markdown-body span.frame span img{display:block;float:left}
.markdown-body span.frame span span{clear:both;color:#333;display:block;padding:5px 0 0}
.markdown-body span.align-center>span{display:block;overflow:hidden;text-align:center;margin:13px auto 0}
.markdown-body span.align-center span img{text-align:center;margin:0 auto}
.markdown-body span.align-right>span{display:block;overflow:hidden;text-align:right;margin:13px 0 0}
.markdown-body span.align-right span img{text-align:right;margin:0}
.markdown-body span.float-left{display:block;margin-right:13px;overflow:hidden;float:left}
.markdown-body span.float-left span{margin:13px 0 0}
.markdown-body span.float-right{display:block;margin-left:13px;overflow:hidden;float:right}
.markdown-body span.float-right>span{display:block;overflow:hidden;text-align:right;margin:13px auto 0}
.markdown-body code,.markdown-body tt{border:1px solid #eaeaea;background-color:#f8f8f8;border-radius:3px;margin:0 2px;padding:0 5px}
.markdown-body pre>code{white-space:pre;border:none;background:transparent;margin:0;padding:0}
.markdown-body .highlight pre,.markdown-body pre{background-color:#f8f8f8;border:1px solid #ccc;font-size:13px;line-height:19px;overflow:auto;border-radius:3px;padding:6px 10px}
.markdown-body pre code,.markdown-body pre tt{background-color:transparent;border:none;margin:0;padding:0}
.highlight .err{color:#a61717;background-color:#e3d2d2}
.highlight .cs{color:#999;font-weight:700;font-style:italic}
.highlight .gd{color:#000;background-color:#fdd}
.highlight .gd .x{color:#000;background-color:#faa}
.highlight .gi{color:#000;background-color:#dfd}
.highlight .gi .x{color:#000;background-color:#afa}
.highlight .gu{color:purple;font-weight:700}
.highlight .nb{color:#0086B3}
.highlight .ni{color:purple}
.highlight .nt{color:navy}
.highlight .sr{color:#009926}
.highlight .ss{color:#990073}
.highlight .gc{color:#999;background-color:#EAF2F5}
.type-csharp .highlight .nf{color:#000;font-weight:400}
.type-csharp .highlight .nc{color:#2B91AF}
.highlight .gh,.highlight .bp{color:#999}
.type-csharp .highlight .nn{color:#000}
.highlight{background:#fff}
.highlight .w{color:#bbb}
.highlight .c,.highlight .cm,.highlight .c1{color:#998;font-style:italic}
.highlight .cp{color:#999;font-weight:700}
.highlight .gr,.highlight .gt{color:#a00}
.highlight .go{color:#888}
.highlight .gp,.highlight .nn{color:#555}
.highlight .kt,.highlight .nc{color:#458;font-weight:700}
.highlight .m,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo,.highlight .il{color:#099}
.highlight .s,.highlight .sb,.highlight .sc,.highlight .sd,.highlight .s2,.highlight .se,.highlight .sh,.highlight .si,.highlight .sx,.highlight .s1{color:#d14}
.highlight .na,.highlight .no,.highlight .nv,.highlight .vc,.highlight .vg,.highlight .vi{color:teal}
.highlight .ne,.highlight .nf{color:#900;font-weight:700}
.type-csharp .highlight .k,.type-csharp .highlight .kt{color:#00F}
.type-csharp .highlight .s,.type-csharp .highlight .sc{color:#A31515}
EOF

html = STDIN.read
render(html)
